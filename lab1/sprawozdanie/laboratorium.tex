% !TEX encoding = cp1250

\chapter{Sygna³y zaszumione}
Program do generowania sygna³u zaszumionego, a nastêpnie jego odszumiania razem z komentarzami zosta³ umieszczony poni¿ej:

Stworzenie sygna³u oryginalnego z szumem:

\begin{lstlisting}
% Parametry systemu
Fs = 1000;     % Czêstotliwoœæ próbkowania [Hz]
T = 1/Fs;      % Okres próbkowania [s]
L = 2000;      % D³ugoœæ sygna³u (liczba próbek)
t = (0:L-1)*T; % Podstawa czasu

% Przygotowanie sygna³u
N = 3;               % Liczba sinusoid w mieszaninie
A = [1.0   0.4  0.8] % Amplitudy kolejnych sinusoid
B = [ 15    27   83] % Czêstotliwoœci kolejnych sygna³ów [Hz]
C = [  0 -pi/3 pi/7] % Przesuniêcia fazowe kolejnych sygna³ów

x = zeros(size(t));
for i = 1:N
  x = x + A(i) * cos(2 * pi * B(i) * t + C(i));
end
x_orig = x;
x=x+randn(size(t))/3;
\end{lstlisting}

Wyznaczenie transformaty Fouriera i dostosowanie danych:

\begin{lstlisting}
Y = fft(x);     % transformata Fouriera

A = abs(Y);     % amplituda sygna³u
A = A/L;        % normalizacja amplitudy

A = A(1:L/2+1); % wyciêcie istotnej czêœci spektrum
A(2:end-1) = 2*A(2:end-1);

F = angle(Y);   % faza sygna³u
F = F(1:L/2+1); % wyciêcie istotnej czêœci spektrum

f_step = Fs/L;     % zmiana czêstotliwoœci
f = 0:f_step:Fs/2; % oœ czêstotliwoœci do wykresu
\end{lstlisting}

Wykresy amplitudowy i fazowy:

\begin{lstlisting}
figure;
subplot(2, 1, 1)
plot(f, A);        % wykres amplitudowy
% figure;
subplot(2, 1, 2)
plot(f, F);        % wykres fazowy
\end{lstlisting}

Odtworzenie sygna³u z danych pozyskanych z transformaty Fouriera i narysowanie wykresu:

\begin{lstlisting}
odtw = zeros(size(t));
[maxA, maxI] = maxk(A, 3);
freq = maxI;
freq = freq - 1;
freq = freq/2;
maxA
maxI
freq
for i=1:3
    odtw = odtw + maxA(i) * cos(2 * pi * freq(i) * t + F(maxI(i)));
end

plot_size = 300;
figure; plot(x(1:plot_size));
hold on; plot(odtw(1:plot_size));
legend('Original with noise', 'Recreated');

figure; plot(x_orig(1:plot_size));
hold on; plot(odtw(1:plot_size));
legend('Original without noise', 'Recreated');
\end{lstlisting}

Wynik dzia³ania tego programu zosta³ przedstawiony na rys.~\ref{no_noise} oraz rys.~\ref{with_noise}.
Jak ³atwo zauwa¿yæ na rys.~\ref{no_noise} oba wykresy siê dok³adnie pokrywaj¹.
Jest to spowodowane faktem, ¿e sygna³ oryginalny sk³ada siê wy³¹cznie z trzech fali sinusoidalnych, wiêc je¿eli odzyskamy ten sygna³ przy pomocy równie¿ trzech sinusoid otrzymamy dok³adnie ten sam sygna³. 

Sytuacja ma siê inaczej na rys.~\ref{with_noise} gdzie sygna³ oryginalny zosta³ zaszumiony.
Sygna³ zosta³ odzyskany z doœæ dobr¹ dok³adnoœci¹, ale nie jest to dok³adnie to samo. 

\begin{figure}
\centering
\includegraphics[width=1\textwidth]{dane/no_noise}
\caption{Sygna³ odzyskany na³o¿ony na sygna³ oryginalny bez zaszumienia}
\label{no_noise}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=1\textwidth]{dane/with_noise}
\caption{Sygna³ odzyskany na³o¿ony na zaszumiony sygna³ oryginalny}
\label{with_noise}
\end{figure}

\chapter{Optyczny system pomiaru têtna}
Do pomiaru têtna zosta³ wykorzystany film dostarczony przez prowadz¹cego zajêcia.
Nastêpnie film zosta³ przerobiony na pojedyncze zdjêcia przy pomocy programu \verb|Adobe Media Encoder|.
Ca³y program zosta³ przedstawiony razem z komentarzami poni¿ej.

Wczytanie zdjêæ:

\begin{lstlisting}
% Liczba ramek do wczytania (przy 10 sekundach i 30 FPS bêdzie to 300)
N = 321;

% wektor jasnoœci
br = zeros(1, N);

% lista obrazów do analizy
imds = imageDatastore('movie', 'FileExtension', '.jpg');

% alternatywnie mo¿na za³adowaæ bezpoœrednio plik wideo
% v = VideoReader('movie.mp4');

% wczytanie pierwszych N obrazów i analiza jasnoœci
for i=1:N
    % wczytujemy obraz i przekszta³camy go do skali szaroœci
    I = rgb2gray(imread(imds.Files{i}));
    % dla pliku wideo ³adowanie ramki z otwartego Ÿród³a
    % I = rgb2gray(read(v,i));

    % wyznaczamy œredni¹ z ca³ego obrazu
    br(i) = mean(I, 'all');
end
\end{lstlisting}

Przetworzenie danych z obrazów:

\begin{lstlisting}
% dla u³atwienia póŸniejszej analizy od razu mo¿na odj¹æ od sygna³u sk³adow¹ sta³¹
br = br - mean(br);

% Parametry systemu
Fs = 30;     % Czêstotliwoœæ próbkowania [Hz]
T = 1/Fs;      % Okres próbkowania [s]
L = N;         % D³ugoœæ sygna³u (liczba próbek)
t = (0:L-1)*T; % Podstawa czasu

x = br;
Y = fft(x);     % transformata Fouriera

A = abs(Y);     % amplituda sygna³u
A = A/L;        % normalizacja amplitudy

A = A(1:L/2+1); % wyciêcie istotnej czêœci spektrum
A(2:end-1) = 2*A(2:end-1);

F = angle(Y);   % faza sygna³u
F = F(1:L/2+1); % wyciêcie istotnej czêœci spektrum

f_step = Fs/L;     % zmiana czêstotliwoœci
f = 0:f_step:Fs/2; % oœ czêstotliwoœci do wykresu
\end{lstlisting}

Narysowanie wykresów i wyznaczenie têtna w uderzeniach na minutê:

\begin{lstlisting}
figure;
subplot(2, 1, 1)
plot(f, A);        % wykres amplitudowy
subplot(2, 1, 2)
plot(f, F);        % wykres fazowy

[maxA, maxI] = maxk(A, 1);
bmp = f(maxI)*60

plot_size = 300;
figure; plot(br(1:plot_size));

\end{lstlisting}

Wynik tego programu zosta³ przedstawiony na rys.~\ref{heart_rate} oraz zosta³ wypisany w konsoli:

\begin{equation}
bmp = \num{67.2897}
\label{bmp}
\end{equation}

Jak widaæ têtno przedstawione na rys.~\ref{heart_rate} jest klarownie widoczne i mo¿na by je zmierzyæ nawet zliczaj¹c przejœcia sygna³u przez 0.

Równie¿ têtno zmierzone przy pomocy transformaty Fouriera (równanie~\ref{bmp}) jest w pe³ni normalne, wiêc jest to wynik najpewniej poprawny.

Na rozdzielczoœæ pomiaru sk³ada siê wy³¹cznie liczba klatek na sekundê zarejestrowanych w filmie.
W tym wypadku film mia³ 30 klatek na sekundê, wiêc pomiar mia³ rozdzielczoœæ 30Hz.
Aby zwiêkszyæ dok³adnoœæ pomiaru nale¿a³oby nagraæ film w wiêkszej liczbie klatek na sekundê.


\begin{figure}
\centering
\includegraphics[width=1\textwidth]{dane/heart_rate}
\caption{Reprezentacja graficzna zmierzonego têtna}
\label{heart_rate}
\end{figure}
